<?php

$input = file_get_contents('sample.txt');
$lines = preg_split('/([\r\n]+)/', $input);
$tree = array();

function parse(&$t) {
	global $lines;
	global $tree;
	while (count($lines) > 0) {
		$line = array_shift($lines);
//		print $line . "\n";
		if (preg_match('/^\$ ([a-z]+)(?: (.*)){0,1}$/', $line, $matches)) {
			$cmd = $matches[1];
			$parameters = isset($matches[2]) ? $matches[2] : '';
			switch ($cmd) {
				case 'cd': {
					switch ($parameters) {
						case '/': {
							parse($tree);
							return;
						}

						case '..': {
							return;
						}

						default: {
							if (!isset($t[$parameters])) {
								$t[$parameters] = array();
							}
							parse($t[$parameters]);
							break;
						}
					}
					break;
				}

				case 'ls': {
					break;
				}
			}
		} else if (preg_match('/^([0-9]+) (.+)$/', $line, $matches)) {
			$size = (int)$matches[1];
			$name = $matches[2];
			$t[$name] = $size;
		} else if (preg_match('/^dir (.+)$/', $line, $matches)) {
			$name = $matches[1];
			$t[$name] = array();
		}
	}
}
parse($tree);
print var_export($tree, true) . "\n";

function dir_size($t, $n) {
	print "dir_size(" . $n . "): ";
	$total = 0;
	foreach($t as $n => $s) {
		if (is_array($s)) {
			$total += dir_size($s, $n);
		} else {
			$total += $s;
		}
	}

	print $total . "\n";
	return $total;
}

foreach ($tree as $name => $subdir) {
	print "'" . $name ."'\n";
	if (is_array($subdir)) {
		$size = dir_size($subdir, $name);
		print $size . "\n";
	}
}


?>
